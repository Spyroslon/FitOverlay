<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Overlay Generator</title>
    <style>
        :root {
            --strava-orange: #fc4c02;
            --strava-dark-orange: #e64c02;
            --strava-background: #f5f5f5;
            --strava-text: #2c3e50;
            --strava-gray: #a0a0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--strava-background);
            color: var(--strava-text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px; /* Reduced padding */
        }

        .container {
            max-width: 600px; /* Increased to accommodate square canvas */
            width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 15px; /* Reduced padding */
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; /* Added to position auth-status */
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        h1 {
            color: var(--strava-orange);
            text-align: center;
            margin-bottom: 0;
            margin-right: 10px;
            font-size: 1.5rem; /* Smaller font size */
        }

        h1 span {
            color: var(--strava-text);
        }

        .input-group {
            margin-bottom: 8px; /* Reduced margin */
        }

        .strava-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 400px) {
            .strava-input {
                flex-direction: column;
                gap: 5px;
            }
        }

        input, button {
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input {
            flex-grow: 1;
            border: 2px solid var(--strava-orange);
        }

        .load-btn {
            background-color: var(--strava-orange);
            color: white;
            border: none;
            cursor: pointer;
            min-width: 100px;
        }

        .load-btn:hover {
            background-color: var(--strava-dark-orange);
        }

        #overlayOptions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .overlay-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--strava-gray);
            color: white;
            padding: 8px; /* Reduced padding */
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem; /* Smaller font size */
        }

        .overlay-option.active {
            background-color: var(--strava-orange);
        }

        .color-picker-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .option-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--strava-text);
            font-size: 0.875rem;
        }

        .color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            border: 3px solid var(--strava-orange);
            cursor: pointer;
            border-radius: 12px;
            padding: 0;
            background-color: var(--strava-text);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .color-picker:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
        }
        .color-picker::-moz-color-swatch {
            border: none;
            border-radius: 8px;
        }
        .color-picker::-ms-color-swatch {
            border: none;
            border-radius: 8px;
        }

        .canvas-container {
            display: block;
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            margin: 15px 0;
            max-width: 100%;
            overflow: hidden;
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px dashed var(--strava-orange);
            border-radius: 8px;
            max-width: 100%;
        }

        @media (max-width: 840px) { /* 800px + 40px padding */
            .canvas-container {
                width: 100%;
                margin: 15px 0;
            }
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex-grow: 1;
            background-color: var(--strava-text);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--strava-orange);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .status-message {
            margin: 0;
            padding: 0;
            border-radius: 6px;
            font-size: 0.9rem;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .status-message.show {
            opacity: 1;
            max-height: 60px;
            margin-top: 8px;
            padding: 8px 12px;
        }

        .status-message.success {
            background-color: #4CAF50;
            color: white;
        }

        .status-message.error {
            background-color: #f44336;
            color: white;
        }

        .auth-status {
            position: static;
            margin-left: auto;
        }

        .auth-button {
            padding: 12px;
            border: 2px solid;
            background: transparent;
            font-weight: 600;
            min-width: 100px;
            transition: all 0.3s ease;
        }

        .auth-button.logged-out {
            color: #ff4444;
            border-color: #ff4444;
            background-color: rgba(255, 68, 68, 0.05);
        }

        .auth-button.logged-in {
            color: #4CAF50;
            border-color: #4CAF50;
            background-color: rgba(74, 175, 80, 0.05);
        }

        .auth-button:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        @media (max-width: 500px) {
            .strava-input {
                flex-direction: column;
            }
            
            .auth-status {
                margin-left: 0;
                margin-top: 10px;
                align-self: flex-end;
            }
        }

        @media (max-width: 840px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 8px;
            }

            .strava-input {
                flex-wrap: wrap;
                gap: 8px;
            }

            .auth-status {
                flex: 0 0 auto;
                margin: 0;
                min-width: 100px;
            }

            .auth-button {
                width: auto;
                min-width: 100px;
            }

            input {
                min-width: 200px;
                flex: 1;
            }

            .load-btn {
                width: auto;
                min-width: 100px;
            }

            #overlayOptions {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .canvas-container {
                margin: 15px 0;
            }

            .color-picker-container {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .action-buttons {
                gap: 10px;
                flex-direction: row;
            }

            .action-buttons button {
                width: auto;
                flex: 1;
            }

            .header-container {
                flex-wrap: nowrap;
                gap: 10px;
            }

            h1 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .strava-input {
                flex-direction: column;
            }

            input, .load-btn, .auth-button {
                width: 100%;
            }

            #overlayOptions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 360px) {
            #overlayOptions {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-container">
            <h1><span>FitOverlay</span> a Strava Overlay Generator</h1>
            <div class="auth-status">
                <button id="auth-button" class="auth-button logged-out">
                    Login
                </button>
            </div>
        </div>

        <div class="input-group">
            <div class="strava-input">
                <input type="text" id="activityInput" placeholder="Enter Strava Activity URL or ID" required>
                <button id="loadActivityBtn" class="load-btn">Load</button>
            </div>
            <div id="statusMessage" class="status-message"></div>
        </div>

        <div class="canvas-container">
            <canvas id="overlayCanvas"></canvas>
        </div>

        <div class="input-group">
            <label class="option-label">Overlay Options</label>
            <div id="overlayOptions">
                <div class="overlay-option" data-metric="distance">
                    Distance
                </div>
                <div class="overlay-option" data-metric="pace">
                    Pace
                </div>
                <div class="overlay-option" data-metric="elevation">
                    Elevation
                </div>
                <div class="overlay-option" data-metric="time">
                    Time
                </div>
                <div class="overlay-option" data-metric="heartRate">
                    Heart Rate
                </div>
            </div>
        </div>

        <div class="color-picker-container">
            <label for="colorWheel" class="option-label">Text Color</label>
            <input type="color" id="colorWheel" value="#ffffff" class="color-picker">
        </div>

        <div class="action-buttons">
            <button id="exportTextBtn">Export Text</button>
            <button id="copyImageBtn">Copy Image</button>
        </div>
    </div>
    <div class="toast" id="toast">Copied to clipboard!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Update checkAuth function
            async function checkAuth() {
                try {
                    const response = await fetch("/status", {
                        credentials: "include"
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    const button = document.getElementById("auth-button");
                    if (data.authenticated) {
                        button.textContent = "Logout";
                        button.classList.remove("logged-out");
                        button.classList.add("logged-in");
                        state.isAuthenticated = true;
                        enableActivityInput();
                    } else {
                        button.textContent = "Login";
                        button.classList.remove("logged-in");
                        button.classList.add("logged-out");
                        state.isAuthenticated = false;
                        disableActivityInput();
                    }
                } catch (error) {
                    console.error("Auth check failed:", error);
                    const button = document.getElementById("auth-button");
                    button.textContent = "Login";
                    button.classList.remove("logged-in");
                    button.classList.add("logged-out");
                    state.isAuthenticated = false;
                    disableActivityInput();
                    showStatusMessage('Error checking authentication status'); // Add error message
                }
            }

            // Update auth button click handler
            document.getElementById("auth-button").addEventListener("click", function() {
                if (this.classList.contains("logged-out")) {
                    // User is logged out, redirect to login
                    window.location.href = "/login";
                } else {
                    // User is logged in, redirect to logout
                    window.location.href = "/logout";
                }
            });

            // Check auth status on load
            checkAuth();

            // Existing code
            const activityInput = document.getElementById('activityInput');
            const loadActivityBtn = document.getElementById('loadActivityBtn');
            const overlayCanvas = document.getElementById('overlayCanvas');
            const colorWheel = document.getElementById('colorWheel');
            const exportTextBtn = document.getElementById('exportTextBtn');
            const copyImageBtn = document.getElementById('copyImageBtn');
            const ctx = overlayCanvas.getContext('2d');
            
            // Set fixed canvas dimensions for high quality
            overlayCanvas.width = 1500; // Square dimensions, high resolution
            overlayCanvas.height = 1500;

            // Enable image smoothing
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // State management
            const state = {
                activityId: null,
                selectedMetrics: [],
                textColor: '#ffffff',
                backgroundColor: '#2c3e50', // Default background color (accessible dark blue)
                template: 'minimal',
                isAuthenticated: false, // Add authentication state
            };
            
            // Message handling system
            const messageQueue = {
                timer: null,
                currentMessage: null,
                clear() {
                    if (this.timer) {
                        clearTimeout(this.timer);
                        this.timer = null;
                    }
                }
            };

            // Single implementation of message handling
            function showStatusMessage(message, type = 'error') {
                const statusMessage = document.getElementById('statusMessage');
                messageQueue.clear();
                
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type} show`;
                
                messageQueue.timer = setTimeout(() => {
                    statusMessage.classList.remove('show');
                    messageQueue.timer = null;
                    messageQueue.currentMessage = null;
                }, 3000);
                
                messageQueue.currentMessage = message;
            }

            function showLoginRequired(action) {
                showStatusMessage(`Please login to ${action}`);
            }

            function hideStatusMessage() {
                messageQueue.clear();
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.classList.remove('show');
            }

            // Mock Strava API data (replace with actual API call)
            const mockStravaData = {
                distance: 10.5,
                pace: '5:30',
                elevation: 250,
                time: '01:02:15',
                heartRate: 162
            };

            // Set fixed canvas dimensions
            function initCanvas() {
                generateOverlay(mockStravaData);
            }

            // Replace resizeCanvas with initCanvas
            initCanvas();

            function extractActivityId(input) {
                // Handle full Strava URLs
                const urlMatch = input.match(/activities\/(\d+)/);
                if (urlMatch) return urlMatch[1];
                
                // Handle direct ID input
                const idMatch = input.match(/^\d+$/);
                if (idMatch) return input;
                
                return null;
            }

            async function fetchActivityData(activityId) {
                const fetchResponse = await fetch(`/fetch_activity/${activityId}`, {
                    credentials: "include"  // Include credentials for authentication
                });
                
                if (!fetchResponse.ok) {
                    const error = new Error('Failed to fetch activity data');
                    error.status = fetchResponse.status;
                    // Get the error details from response
                    const errorData = await fetchResponse.json();
                    error.message = errorData.error || error.message;
                    throw error;
                }
                
                return await fetchResponse.json();
            }

            // Update overlay option handler
            document.querySelectorAll('.overlay-option').forEach(option => {
                option.addEventListener('click', () => {
                    if (!state.isAuthenticated) {
                        showLoginRequired('customize overlays');
                        return;
                    }
                    if (!state.activityId) {
                        showStatusMessage('Please load an activity first to customize overlays');
                        return;
                    }

                    option.classList.toggle('active');
                    const metric = option.dataset.metric;
                    
                    if (state.selectedMetrics.includes(metric)) {
                        state.selectedMetrics = state.selectedMetrics.filter(m => m !== metric);
                    } else {
                        state.selectedMetrics.push(metric);
                    }

                    if (state.activityId) {
                        generateOverlay(mockStravaData);
                    }
                });
            });

            // Update color wheel handler
            colorWheel.addEventListener('input', (e) => {
                if (!state.isAuthenticated) {
                    showLoginRequired('customize colors');
                    return;
                }
                if (!state.activityId) {
                    showStatusMessage('Please load an activity first to customize colors');
                    return;
                }

                state.textColor = e.target.value;
                generateOverlay(mockStravaData);
            });

            // Generate Overlay
            function generateOverlay(data) {
                // Clear the entire canvas
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

                // Draw background color
                ctx.fillStyle = state.backgroundColor;
                ctx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                drawMetrics(data);
            }

            function drawMetrics(data, context = ctx) {
                // Calculate center position
                const centerX = overlayCanvas.width / 2;
                const centerY = overlayCanvas.height / 2;

                // Adjust font sizes for square canvas
                const metricsCount = Math.max(1, state.selectedMetrics.length);
                const titleFontSize = Math.min(80, 160 * (5 / metricsCount));
                const valueFontSize = Math.min(100, 200 * (5 / metricsCount));
                const spacing = Math.min(60, 120 * (5 / metricsCount));

                const metrics = [
                    { name: 'Distance', value: `${data.distance} km`, key: 'distance' },
                    { name: 'Pace', value: `${data.pace} min/km`, key: 'pace' },
                    { name: 'Elevation', value: `${data.elevation} m`, key: 'elevation' },
                    { name: 'Time', value: data.time, key: 'time' },
                    { name: 'Heart Rate', value: `${data.heartRate} bpm`, key: 'heartRate' }
                ];

                const selectedMetrics = metrics.filter(metric => 
                    state.selectedMetrics.includes(metric.key)
                );

                const totalHeight = selectedMetrics.length * (titleFontSize + valueFontSize + spacing);
                let yOffset = centerY - (totalHeight / 2);

                // Styling
                context.fillStyle = state.textColor;
                context.textAlign = 'center';
                context.textBaseline = 'top';

                selectedMetrics.forEach(metric => {
                    // Title
                    context.font = `bold ${titleFontSize}px Arial`;
                    context.fillText(metric.name, centerX, yOffset);
                    
                    // Value
                    context.font = `bold ${valueFontSize}px Arial`;
                    context.fillText(metric.value, centerX, yOffset + titleFontSize + 10);
                    
                    yOffset += titleFontSize + valueFontSize + spacing;
                });
            }

            function measureTextBounds(context, metrics, titleFontSize, valueFontSize, spacing) {
                let minX = overlayCanvas.width;
                let maxX = 0;
                let minY = overlayCanvas.height;
                let maxY = 0;
                
                metrics.forEach(metric => {
                    // Measure title
                    context.font = `bold ${titleFontSize}px Arial`;
                    const titleWidth = context.measureText(metric.name).width;
                    // Measure value
                    context.font = `bold ${valueFontSize}px Arial`;
                    const valueWidth = context.measureText(metric.value).width;
                    
                    const width = Math.max(titleWidth, valueWidth);
                    minX = Math.min(minX, (overlayCanvas.width - width) / 2);
                    maxX = Math.max(maxX, (overlayCanvas.width + width) / 2);
                });

                const totalHeight = metrics.length * (titleFontSize + valueFontSize + spacing);
                const startY = (overlayCanvas.height - totalHeight) / 2;
                minY = startY;
                maxY = startY + totalHeight;

                return { minX, maxX, minY, maxY };
            }

            function getCroppedDimensions(data, context) {
                const metricsCount = Math.max(1, state.selectedMetrics.length);
                const titleFontSize = Math.min(80, 160 * (5 / metricsCount));
                const valueFontSize = Math.min(100, 200 * (5 / metricsCount));
                const spacing = Math.min(60, 120 * (5 / metricsCount));

                const metrics = [
                    { name: 'Distance', value: `${data.distance} km`, key: 'distance' },
                    { name: 'Pace', value: `${data.pace} min/km`, key: 'pace' },
                    { name: 'Elevation', value: `${data.elevation} m`, key: 'elevation' },
                    { name: 'Time', value: data.time, key: 'time' },
                    { name: 'Heart Rate', value: `${data.heartRate} bpm`, key: 'heartRate' }
                ].filter(metric => state.selectedMetrics.includes(metric.key));

                const bounds = measureTextBounds(context, metrics, titleFontSize, valueFontSize, spacing);
                const margin = 40;

                return {
                    x: Math.max(0, bounds.minX - margin),
                    y: Math.max(0, bounds.minY - margin),
                    width: Math.min(overlayCanvas.width, bounds.maxX - bounds.minX + 2 * margin),
                    height: Math.min(overlayCanvas.height, bounds.maxY - bounds.minY + 2 * margin)
                };
            }

            function showToast() {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            function showActionRequired(action) {
                if (!state.isAuthenticated) {
                    showLoginRequired(action);
                    return true;
                }
                if (!state.activityId) {
                    showStatusMessage('Please load an activity first before exporting');
                    return true;
                }
                return false;
            }

            // Update export button handlers
            exportTextBtn.addEventListener('click', async () => {
                if (showActionRequired('export activities')) return;
                const metrics = [
                    { name: 'Distance', value: `${mockStravaData.distance} km`, key: 'distance' },
                    { name: 'Pace', value: `${mockStravaData.pace} min/km`, key: 'pace' },
                    { name: 'Elevation', value: `${mockStravaData.elevation} m`, key: 'elevation' },
                    { name: 'Time', value: `${mockStravaData.time}`, key: 'time' },
                    { name: 'Heart Rate', value: `${mockStravaData.heartRate} bpm`, key: 'heartRate' }
                ];

                const exportText = metrics
                    .filter(metric => state.selectedMetrics.includes(metric.key))
                    .map(metric => `${metric.name}\n${metric.value}`)
                    .join('\n\n');

                try {
                    await navigator.clipboard.writeText(exportText);
                    showToast();
                } catch (err) {
                    // Create temporary textarea element for iOS
                    const textarea = document.createElement('textarea');
                    textarea.value = exportText;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast();
                    } catch (err) {
                        console.error('Unable to copy text to clipboard');
                    }
                    document.body.removeChild(textarea);
                }
            });

            copyImageBtn.addEventListener('click', async () => {
                if (showActionRequired('export activities')) return;
                const dimensions = getCroppedDimensions(mockStravaData, ctx);
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = dimensions.width;
                tempCanvas.height = dimensions.height;
                const tempCtx = tempCanvas.getContext('2d');

                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.save();
                tempCtx.translate(-dimensions.x, -dimensions.y);
                drawMetrics(mockStravaData, tempCtx);
                tempCtx.restore();

                try {
                    const blob = await new Promise(resolve => tempCanvas.toBlob(resolve));
                    
                    // For iOS devices
                    if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                        tempCanvas.toBlob(async (blob) => {
                            try {
                                const item = new ClipboardItem({ 'image/png': blob });
                                await navigator.clipboard.write([item]);
                                showToast();
                                return;
                            } catch (err) {
                                console.error('iOS clipboard write failed:', err);
                            }
                        }, 'image/png');
                        return;
                    }

                    // For other mobile devices
                    if (/Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        try {
                            const item = new ClipboardItem({ 'image/png': blob });
                            await navigator.clipboard.write([item]);
                            showToast();
                            return;
                        } catch (err) {
                            console.error('Mobile clipboard write failed:', err);
                        }
                    }

                    // Desktop fallback
                    try {
                        const item = new ClipboardItem({ 'image/png': blob });
                        await navigator.clipboard.write([item]);
                        showToast();
                    } catch (err) {
                        console.error('Clipboard write failed:', err);
                        // Only download as absolute last resort
                        const shouldDownload = confirm('Unable to copy to clipboard. Download image instead?');
                        if (shouldDownload) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = 'strava-overlay.png';
                            link.href = url;
                            link.click();
                            URL.revokeObjectURL(url);
                        }
                    }
                } catch (err) {
                    console.error('Unable to process image:', err);
                }
            });

            // Update load activity button click handler
            loadActivityBtn.addEventListener('click', async () => {
                if (!state.isAuthenticated) {
                    showLoginRequired('load activities');
                    return;
                }

                const input = activityInput.value.trim();
                const activityId = extractActivityId(input);
                
                if (!activityId) {
                    showStatusMessage('Please enter a valid Strava activity URL or ID', 'error');
                    return;
                }

                loadActivityBtn.disabled = true;

                try {
                    const activityData = await fetchActivityData(activityId);
                    state.activityId = activityId;
                    
                    // Update mockStravaData with real data
                    mockStravaData.distance = (activityData.distance / 1000).toFixed(2);
                    mockStravaData.time = new Date(activityData.moving_time * 1000).toISOString().substr(11, 8);
                    mockStravaData.elevation = Math.round(activityData.total_elevation_gain);
                    mockStravaData.pace = ((activityData.moving_time / 60) / (activityData.distance / 1000)).toFixed(2);
                    mockStravaData.heartRate = activityData.average_heartrate ? Math.round(activityData.average_heartrate) : 0;

                    generateOverlay(mockStravaData);
                    exportTextBtn.disabled = false;
                    copyImageBtn.disabled = false;
                    
                    showStatusMessage(`Activity "${activityData.name}" loaded successfully`, 'success');
                } catch (error) {
                    console.error('Error loading activity:', error);
                    if (error.status === 401) {
                        showStatusMessage('Please login to access activities', 'error');
                    } else if (error.status === 403) {
                        showStatusMessage('You do not have permission to access this activity', 'error');
                    } else if (error.status === 429) {
                        showStatusMessage('Too many requests. Please wait a minute before trying again.', 'error');
                    } else {
                        // Always show this generic message for other errors
                        showStatusMessage('Failed to load activity. Please check the activity ID and try again.', 'error');
                    }
                } finally {
                    loadActivityBtn.disabled = false;
                }
            });

            // Add functions to enable/disable activity input
            function enableActivityInput() {
                activityInput.disabled = false;
                loadActivityBtn.disabled = false;
                activityInput.placeholder = "Enter Strava Activity URL or ID";
            }

            function disableActivityInput() {
                activityInput.disabled = true;
                // Don't disable load button to allow error message trigger
                loadActivityBtn.disabled = false;
                activityInput.placeholder = "Please login to load activities";
                // Clear any existing activity data
                state.activityId = null;
                generateOverlay(mockStravaData);
                // Don't show message immediately, wait for user interaction
            }

        });
    </script>
</body>
</html>